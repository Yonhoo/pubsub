<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubSub èŠå¤©å®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 800px;
            min-height: 0; /* ç¡®ä¿ flex å­å…ƒç´ å¯ä»¥æ­£ç¡®æ”¶ç¼© */
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .login-section {
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .login-section.hidden {
            display: none;
        }

        .input-group {
            width: 100%;
            max-width: 400px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-section {
            display: none;
            flex: 1;
            flex-direction: column;
            min-height: 0; /* ç¡®ä¿ flex å­å…ƒç´ å¯ä»¥æ­£ç¡®æ”¶ç¼© */
        }

        .chat-section.active {
            display: flex;
        }

        .chat-info {
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-info span {
            color: #666;
            font-size: 14px;
        }

        .chat-info strong {
            color: #333;
        }

        .messages {
            flex: 1;
            min-height: 0; /* ç¡®ä¿å¯ä»¥æ»šåŠ¨ */
            padding: 20px 30px;
            overflow-y: auto;
            overflow-x: hidden;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message.system {
            align-self: center;
            max-width: 90%;
        }

        .message-header {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
            color: #666;
        }

        .message-sender {
            font-weight: 600;
            color: #667eea;
        }

        .message-time {
            color: #999;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.other .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .message.system .message-bubble {
            background: #fffbea;
            color: #856404;
            text-align: center;
            border-radius: 10px;
            font-size: 13px;
            padding: 8px 16px;
        }

        .input-area {
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ï¼Œå§‹ç»ˆå¯è§ */
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-area input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .error-message {
            color: #ff4444;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ PubSub èŠå¤©å®¤</h1>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-section" id="loginSection">
            <div class="input-group">
                <label for="userId">ç”¨æˆ· ID</label>
                <input type="text" id="userId" placeholder="è¯·è¾“å…¥ç”¨æˆ· IDï¼Œä¾‹å¦‚ï¼šuser-001" />
            </div>
            <div class="input-group">
                <label for="userName">ç”¨æˆ·å</label>
                <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" />
            </div>
            <div class="input-group">
                <label for="roomId">æˆ¿é—´ ID</label>
                <input type="text" id="roomId" placeholder="è¯·è¾“å…¥æˆ¿é—´ IDï¼Œä¾‹å¦‚ï¼šroom-001" value="room-001" />
            </div>
            <button class="btn" id="joinBtn">åŠ å…¥æˆ¿é—´</button>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div class="chat-section" id="chatSection">
            <div class="chat-info">
                <span>æˆ¿é—´: <strong id="currentRoom">-</strong></span>
                <span>ç”¨æˆ·: <strong id="currentUser">-</strong></span>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
                <button class="send-btn" id="sendBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <!-- ä½¿ç”¨å›½å†… CDN é•œåƒ bootcdn -->
    <script src="https://cdn.bootcdn.net/ajax/libs/protobufjs/7.2.5/protobuf.min.js"></script>
    <script>
        // WebSocket å®¢æˆ·ç«¯ç±»
        class ChatClient {
            constructor() {
                this.ws = null;
                this.userId = null;
                this.userName = null;
                this.roomId = null;
                this.connected = false;
                this.protoRoot = null;
                this.Proto = null;
            }

            async init() {
                // åŠ è½½ protobuf å®šä¹‰
                this.protoRoot = await protobuf.load('/protocol.proto');
                this.Proto = this.protoRoot.lookupType('protocol.Proto');
            }

            connect(userId, userName, roomId) {
                this.userId = userId;
                this.userName = userName;
                this.roomId = roomId;

                const wsUrl = `${CONFIG.WS_URL}?user_id=${userId}&user_name=${userName}&room_id=${roomId}`;
                console.log('ğŸ”— è¿æ¥ WebSocket:', wsUrl);
                this.ws = new WebSocket(wsUrl);
                this.ws.binaryType = 'arraybuffer';

                this.ws.onopen = () => {
                    console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
                    this.connected = true;
                    this.updateStatus(true);
                    this.joinRoom();
                };

                this.ws.onmessage = (event) => {
                    this.handleMessage(event.data);
                };

                this.ws.onerror = (error) => {
                    console.error('âŒ WebSocket é”™è¯¯:', error);
                    this.updateStatus(false);
                    this.showError('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
                };

                this.ws.onclose = () => {
                    console.log('ğŸ‘‹ WebSocket è¿æ¥å…³é—­');
                    this.connected = false;
                    this.updateStatus(false);
                    this.showError('è¿æ¥å·²æ–­å¼€');
                };
            }

            joinRoom() {
                const message = {
                    ver: 1,
                    op: 1, // åŠ å…¥æˆ¿é—´
                    seq: 1,
                    roomid: this.roomId,
                    userid: this.userId,
                    body: new TextEncoder().encode(this.userName)
                };

                this.sendProto(message);
                console.log('ğŸšª å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚');
            }

            sendMessage(text) {
                if (!this.connected) {
                    this.showError('æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                    return;
                }

                // é€šè¿‡ HTTP API å‘é€å¹¿æ’­æ¶ˆæ¯
                const apiUrl = `${CONFIG.API_URL}/broadcast`;
                console.log('ğŸ“¤ å‘é€æ¶ˆæ¯åˆ°:', apiUrl);
                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_id: this.roomId,
                        message: `${this.userName}: ${text}`
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('âœ… æ¶ˆæ¯å·²å‘é€', data);
                    // æ·»åŠ è‡ªå·±çš„æ¶ˆæ¯åˆ°ç•Œé¢
                    this.addMessage({
                        sender: this.userName,
                        content: text,
                        isOwn: true,
                        time: new Date()
                    });
                })
                .catch(error => {
                    console.error('âŒ å‘é€å¤±è´¥:', error);
                    this.showError('å‘é€æ¶ˆæ¯å¤±è´¥');
                });
            }

            sendProto(message) {
                try {
                    // æœåŠ¡å™¨æœŸæœ›çš„äºŒè¿›åˆ¶åè®®æ ¼å¼ï¼š
                    // [packLen(4)] [headerLen(2)] [Ver(2)] [Op(4)] [Seq(4)] [RoomIdLen(2)] [RoomId(...)] [UserIdLen(2)] [UserId(...)] [Body(...)]
                    const roomIdBytes = new TextEncoder().encode(message.roomid || '');
                    const userIdBytes = new TextEncoder().encode(message.userid || '');
                    const bodyBytes = message.body instanceof Uint8Array ? message.body : 
                                     (message.body ? new TextEncoder().encode(String(message.body)) : new Uint8Array(0));
                    
                    const _rawHeaderSize = 16; // 4 + 2 + 2 + 4 + 4
                    const _stringLenSize = 2;
                    
                    // è®¡ç®—æ€»åŒ…é•¿åº¦
                    const packLen = _rawHeaderSize + 
                                   _stringLenSize + roomIdBytes.length +
                                   _stringLenSize + userIdBytes.length +
                                   bodyBytes.length;
                    
                    // åˆ›å»ºæ•°æ®åŒ…
                    const packet = new ArrayBuffer(packLen);
                    const view = new DataView(packet);
                    let offset = 0;
                    
                    // packLen (4å­—èŠ‚ï¼Œå¤§ç«¯)
                    view.setUint32(offset, packLen, false);
                    offset += 4;
                    
                    // headerLen (2å­—èŠ‚ï¼Œå¤§ç«¯ï¼Œå›ºå®šä¸º16)
                    view.setUint16(offset, _rawHeaderSize, false);
                    offset += 2;
                    
                    // Ver (2å­—èŠ‚ï¼Œå¤§ç«¯)
                    view.setUint16(offset, message.ver || 1, false);
                    offset += 2;
                    
                    // Op (4å­—èŠ‚ï¼Œå¤§ç«¯)
                    view.setUint32(offset, message.op || 0, false);
                    offset += 4;
                    
                    // Seq (4å­—èŠ‚ï¼Œå¤§ç«¯)
                    view.setUint32(offset, message.seq || 0, false);
                    offset += 4;
                    
                    // RoomIdLen (2å­—èŠ‚ï¼Œå¤§ç«¯) + RoomId
                    view.setUint16(offset, roomIdBytes.length, false);
                    offset += 2;
                    new Uint8Array(packet, offset, roomIdBytes.length).set(roomIdBytes);
                    offset += roomIdBytes.length;
                    
                    // UserIdLen (2å­—èŠ‚ï¼Œå¤§ç«¯) + UserId
                    view.setUint16(offset, userIdBytes.length, false);
                    offset += 2;
                    new Uint8Array(packet, offset, userIdBytes.length).set(userIdBytes);
                    offset += userIdBytes.length;
                    
                    // Body
                    if (bodyBytes.length > 0) {
                        new Uint8Array(packet, offset, bodyBytes.length).set(bodyBytes);
                    }
                    
                    this.ws.send(packet);
                } catch (error) {
                    console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                }
            }

            handleMessage(data) {
                try {
                    // è§£ææœåŠ¡å™¨çš„äºŒè¿›åˆ¶åè®®æ ¼å¼ï¼š
                    // [packLen(4)] [headerLen(2)] [Ver(2)] [Op(4)] [Seq(4)] [RoomIdLen(2)] [RoomId(...)] [UserIdLen(2)] [UserId(...)] [Body(...)]
                    const view = new DataView(data);
                    let offset = 0;
                    
                    // packLen (4å­—èŠ‚ï¼Œå¤§ç«¯)
                    const packLen = view.getUint32(offset, false);
                    offset += 4;
                    
                    // headerLen (2å­—èŠ‚ï¼Œå¤§ç«¯)
                    const headerLen = view.getUint16(offset, false);
                    offset += 2;
                    
                    // Ver (2å­—èŠ‚ï¼Œå¤§ç«¯)
                    const ver = view.getUint16(offset, false);
                    offset += 2;
                    
                    // Op (4å­—èŠ‚ï¼Œå¤§ç«¯)
                    const op = view.getUint32(offset, false);
                    offset += 4;
                    
                    // Seq (4å­—èŠ‚ï¼Œå¤§ç«¯)
                    const seq = view.getUint32(offset, false);
                    offset += 4;
                    
                    // RoomIdLen (2å­—èŠ‚ï¼Œå¤§ç«¯) + RoomId
                    const roomIdLen = view.getUint16(offset, false);
                    offset += 2;
                    const roomId = roomIdLen > 0 ? 
                        new TextDecoder().decode(new Uint8Array(data, offset, roomIdLen)) : '';
                    offset += roomIdLen;
                    
                    // UserIdLen (2å­—èŠ‚ï¼Œå¤§ç«¯) + UserId
                    const userIdLen = view.getUint16(offset, false);
                    offset += 2;
                    const userId = userIdLen > 0 ? 
                        new TextDecoder().decode(new Uint8Array(data, offset, userIdLen)) : '';
                    offset += userIdLen;
                    
                    // Body
                    const bodyLen = packLen - offset;
                    const body = bodyLen > 0 ? new Uint8Array(data, offset, bodyLen) : null;
                    
                    const message = {
                        ver: ver,
                        op: op,
                        seq: seq,
                        roomid: roomId,
                        userid: userId,
                        body: body
                    };
                    
                    console.log('ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯:', message);
                    this.handleProtoMessage(message);
                } catch (error) {
                    console.error('âŒ è§£ææ¶ˆæ¯å¤±è´¥:', error);
                }
            }

            handleProtoMessage(msg) {
                switch (msg.op) {
                    case 2: // åŠ å…¥æˆ¿é—´å“åº” æˆ– å¹¿æ’­æ¶ˆæ¯
                        if (msg.body && msg.body.length > 0) {
                            // å¹¿æ’­æ¶ˆæ¯
                            const content = new TextDecoder().decode(msg.body);
                            // è§£ææ¶ˆæ¯æ ¼å¼: "ç”¨æˆ·å: æ¶ˆæ¯å†…å®¹"
                            const match = content.match(/^(.+?):\s*(.+)$/);
                            if (match) {
                                const [, sender, text] = match;
                                // ä¸æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯æ‰æ˜¾ç¤º
                                if (sender !== this.userName) {
                                    this.addMessage({
                                        sender: sender,
                                        content: text,
                                        isOwn: false,
                                        time: new Date()
                                    });
                                }
                            } else {
                                // ç³»ç»Ÿæ¶ˆæ¯
                                this.addSystemMessage(content);
                            }
                        } else {
                            // åŠ å…¥æˆ¿é—´æˆåŠŸ
                            this.addSystemMessage(`âœ… æˆåŠŸåŠ å…¥æˆ¿é—´: ${msg.roomid}`);
                        }
                        break;

                    case 6: // å¿ƒè·³å“åº”
                        console.log('ğŸ’“ å¿ƒè·³å“åº”');
                        break;

                    default:
                        console.log('âš ï¸ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', msg.op);
                }
            }

            addMessage({ sender, content, isOwn, time }) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;

                const timeStr = time.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${timeStr}</span>
                    </div>
                    <div class="message-bubble">${this.escapeHtml(content)}</div>
                `;

                messagesDiv.appendChild(messageDiv);
                // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°åå†æ»šåŠ¨
                requestAnimationFrame(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
            }

            addSystemMessage(content) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `<div class="message-bubble">${this.escapeHtml(content)}</div>`;
                messagesDiv.appendChild(messageDiv);
                // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM æ›´æ–°åå†æ»šåŠ¨
                requestAnimationFrame(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateStatus(connected) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');

                if (connected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'å·²è¿æ¥';
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'æœªè¿æ¥';
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                setTimeout(() => {
                    errorDiv.textContent = '';
                }, 3000);
            }

            startHeartbeat() {
                setInterval(() => {
                    if (this.connected) {
                        const message = {
                            ver: 1,
                            op: 5, // å¿ƒè·³
                            seq: Math.floor(Date.now() / 1000),
                            roomid: this.roomId,
                            userid: this.userId
                        };
                        this.sendProto(message);
                    }
                }, 30000); // æ¯ 30 ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
            }
        }

        // åˆå§‹åŒ–
        let client = null;

        document.addEventListener('DOMContentLoaded', async () => {
            client = new ChatClient();
            await client.init();

            // åŠ å…¥æˆ¿é—´æŒ‰é’®
            document.getElementById('joinBtn').addEventListener('click', () => {
                const userId = document.getElementById('userId').value.trim();
                const userName = document.getElementById('userName').value.trim();
                const roomId = document.getElementById('roomId').value.trim();

                if (!userId || !userName || !roomId) {
                    client.showError('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                    return;
                }

                // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('chatSection').classList.add('active');
                document.getElementById('currentRoom').textContent = roomId;
                document.getElementById('currentUser').textContent = userName;

                // è¿æ¥ WebSocket
                client.connect(userId, userName, roomId);
                client.startHeartbeat();
            });

            // å‘é€æ¶ˆæ¯
            const sendMessage = () => {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();

                if (!text) return;

                client.sendMessage(text);
                input.value = '';
            };

            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>

